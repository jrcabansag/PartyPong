<!--Thanks to https://codepen.io/ZachSaucier/pen/bBJmbz for the starter code!-->

<!doctype html> 
<html lang="en"> 
<head> 
	<title>Song Pong</title> 
	<style> 
		body { 
			margin:0;
		}
		input {
		    position: absolute;
		    top: 15px;
		    left: 15px;
		}
		.loader {
		    font-family: sans-serif;
		    position: absolute;
		    top: 50%;
		    left: 50%;
		    transform: translate(-50% -50%);
		    display: none;
		}
		.loader.loading  {
			display: block; 
		}
		#bassText{
			position: absolute;
		    top: 115px;
		    left: 15px;
		}
		#canvasDiv{
			width: 1200px;
			height: 800px;
		}
	</style> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.5/p5.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.5/addons/p5.sound.min.js"></script>
	<script>
		var fft;
		var song;
		var numBars = 1024;
		var loader;
		var bassBars = 10;
		var bassMin = .7;
		var bassMax = 1;
		var edgeHeight = 50;
		var screenWidth = 1200;
		var screenHeight = 800;
		var maxRotate = 10;
		// Load our song
		function init(){
			loader = document.querySelector(".loader");
			document.getElementById("audiofile").onchange = function(event) {
			    if(event.target.files[0]) {
			        if(typeof song != "undefined") { // Catch already playing songs
			            song.disconnect();
			            song.stop();
			        }
			        
			        // Load our new song
			        song = loadSound(URL.createObjectURL(event.target.files[0]));
			        loader.classList.add("loading");
			    }
			}
		}

		var canvas;
		function setup() { // Setup p5.js
		    canvas = createCanvas(screenWidth, screenHeight);
		    canvas.parent("canvasDiv");
		    rectMode(CENTER);
		}

		function draw() {
		    background(51);
		    if(typeof song != "undefined" 
		       && song.isLoaded() 
		       && !song.isPlaying()) { // Do once
		        loader.classList.remove("loading");
		        
		        song.play();
		        song.setVolume(0.5);

		        fft = new p5.FFT();
		        fft.waveform(numBars);
		        fft.smooth(0.85);
		    }
		    
		    if(typeof fft != "undefined") {
		        var spectrum = fft.analyze();
		        var totalBass = 0;
		        for(var i = 0; i < numBars; i++) {
		        	if(i <= bassBars){
		        		totalBass += spectrum[i]
						fill("rgb(255, 0, 0)");
		        	}
		        	else{
		        		fill("rgb(0, 255, 0)");
		        	}
		            var x = map(i, 0, numBars, 0, width);
		            var h = -height + map(spectrum[i], 0, 255, height, 0);
		            rect(x, height, width / numBars, h);
		        }
		        var bassPercent = map(totalBass, 0, 255*bassBars, 0, 1);
		        var bassEffect = 0;
		        bassText.innerHTML = ""+bassPercent;
		        noStroke();
				fill("rgb(0, 0, 255)");
		        if(bassPercent >= bassMin){
		        	bassEffect = map(bassPercent, bassMin, bassMax, 0, 255);
		        	bassText.style.color = "#"+bassEffect.toString(16)+"0000";
		        	rotateAmount = map(bassEffect, 0, 255, 0, maxRotate);
				    var rotateAngle = random(rotateAmount)-maxRotate/2;
				    translate(screenWidth/2, edgeHeight/2);
				    rotate(radians(rotateAngle));
				    rect(0, 0, screenWidth, edgeHeight);
				    rotate(-radians(rotateAngle));
				    translate(0, screenHeight-edgeHeight);
				    rotate(radians(rotateAngle));
				    rect(0, 0, screenWidth, edgeHeight);
				    rotate(-radians(rotateAngle));
				    translate(-screenWidth, -screenHeight+edgeHeight*3/2);
		        }
		        else{
		        	rect(screenWidth/2, edgeHeight/2, screenWidth, edgeHeight);
				    rect(screenWidth/2, screenHeight-edgeHeight/2, screenWidth, edgeHeight);
		        	bassText.style.color = "#000000";
		        }

		    }
		}

		function windowResized() {
		  //resizeCanvas(windowWidth, windowHeight);
		}
	</script>
</head> 
<body onload="init()">
	<center>
	<div id="canvasDiv">
	</div>
	<input id="audiofile" type="file"/>
	<h3 class="loader">Loading...</h3>
	<h3 id="bassText"></h3>
	</center>
</body> 
</html>