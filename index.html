<!--Thanks to https://codepen.io/ZachSaucier/pen/bBJmbz for the starter code!-->

<!doctype html> 
<html lang="en"> 
<head> 
	<title>Song Pong</title> 
	<style> 
		body { 
			margin:0;
		}
		input {
		    position: absolute;
		    top: 15px;
		    left: 15px;
		}
		.loader {
		    font-family: sans-serif;
		    position: absolute;
		    top: 50%;
		    left: 50%;
		    transform: translate(-50% -50%);
		    display: none;
		}
		.loader.loading  {
			display: block; 
		}
		#bassText{
			position: absolute;
		    top: 115px;
		    left: 15px;
		}
		#canvasDiv{
			width: 1200px;
			height: 800px;
		}
	</style> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.5/p5.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.5/addons/p5.sound.min.js"></script>
	<script>
		var fft;
		var song;
		var numBars = 1024;
		var loader;
		var bassBars = 10;
		var defaultBassMin = .7;
		var bassMin;
		var bassMax = 1;
		var edgeHeight = 50;
		var screenWidth = 1200;
		var screenHeight = 800;
		var maxRotate = 10;
		var maxEdgeDisplacement = 100;
		var maxEdgeShake = 15;
		var edgeBonus = 50;
		var defaultSoundVolume = 0.5;
		var soundVolume = 0.5;
		var playerX = 75;
		var playerHeight = 160;
		var playerWidth = 12;
		var player1Y = (screenHeight-playerHeight)/2;
		var player2Y = (screenHeight-playerHeight)/2;
		var player1Key = "None"
		var player2Key = "None"
		var playerSpeed = 7;
		var maxPlayerYShake = 7;
		var maxPlayerXShake = 3;
		var maxPlayerSpeedBonus = 5;
		var ballDiameter = 25;
		var ballX = (screenWidth-ballDiameter)/2;
		var ballY = (screenHeight-ballDiameter)/2;
		var defaultBallSpeed = 5;
		var maxBallSpeedBonus = 15;
		var ballXDirection = 1;
		var ballYDirection = 1;


		// Load our song
		function init(){
			loader = document.querySelector(".loader");
			document.getElementById("audiofile").onchange = function(event) {
			    if(event.target.files[0]) {
			        if(typeof song != "undefined") { // Catch already playing songs
			            song.disconnect();
			            song.stop();
			        }
			        
			        // Load our new song
			        song = loadSound(URL.createObjectURL(event.target.files[0]));
			        loader.classList.add("loading");
			    }
			}
			window.addEventListener("keydown", function(e) {
			    // space and arrow keys
			    if([32, 37, 38, 39, 40, 83, 87].indexOf(e.keyCode) > -1) {
			        e.preventDefault();
			    }
			    if(e.keyCode == 87){
			    	player1Key = "Up";
			    }
			    if(e.keyCode == 83){
			    	player1Key = "Down";
			    }
			    if(e.keyCode == 38){
			    	player2Key = "Up";
			    }
			    if(e.keyCode == 40){
			    	player2Key = "Down";
			    }
			}, false);
			window.addEventListener("keyup", function(e) {
			    // space and arrow keys
			    if([32, 37, 38, 39, 40, 83, 87].indexOf(e.keyCode) > -1) {
			        e.preventDefault();
			    }
			    if(e.keyCode == 87 && player1Key == "Up"){
			    	player1Key = "";
			    }
			    if(e.keyCode == 83 && player1Key == "Down"){
			    	player1Key = "";
			    }
			    if(e.keyCode == 38 && player2Key == "Up"){
			    	player2Key = "";
			    }
			    if(e.keyCode == 40 && player2Key == "Down"){
			    	player2Key = "";
			    }
			}, false);
		}

		var canvas;
		function setup() { // Setup p5.js
		    canvas = createCanvas(screenWidth, screenHeight);
		    canvas.parent("canvasDiv");
		    rect(0, 0, screenWidth, edgeHeight);
		    rect(0, screenHeight-edgeHeight, screenWidth, edgeHeight);
		    bassMin = defaultBassMin*(soundVolume/defaultSoundVolume);
		    ellipseMode(CORNER);
		}

		function draw() {
			var edgeDisplacement = 0;
			var edgeShake = 0;
			var bassEffect = 0;
		    background(51);
		    if(typeof song != "undefined" 
		       && song.isLoaded() 
		       && !song.isPlaying()) { // Do once
		        loader.classList.remove("loading");
		        
		        song.play();
		        song.setVolume(soundVolume);

		        fft = new p5.FFT();
		        fft.waveform(numBars);
		        fft.smooth(0.85);
		    }
		    
		    if(typeof fft != "undefined") {
		        var spectrum = fft.analyze();
		        var totalBass = 0;
		        for(var i = 0; i < numBars; i++) {
		        	if(i <= bassBars){
		        		totalBass += spectrum[i]
						//fill("rgb(255, 0, 0)");
		        	}
		        	else{
		        		//fill("rgb(0, 255, 0)");
		        	}
		            var x = map(i, 0, numBars, 0, width);
		            var h = -height + map(spectrum[i], 0, 255, height, 0);
		            //rect(x, height, width / numBars, h);
		        }
		        var bassPercent = map(totalBass, 0, 255*bassBars, 0, 1);
		        bassText.innerHTML = ""+bassPercent;
		        noStroke();
				fill("rgb(255, 255, 255)");
		        if(bassPercent >= bassMin){
		        	bassEffect = map(bassPercent, bassMin, bassMax, 0, 1);
		        	bassText.style.color = "#"+bassEffect.toString(16)+"0000";
		        }
		        else{
		        	bassText.style.color = "#000000"
		        }
		        if(bassPercent >= bassMin){
		        	edgeDisplacement = map(bassEffect, 0, 1, 0, maxEdgeDisplacement);
		        	edgeShake = random(map(bassEffect, 0, 1, 0, maxEdgeShake));
		        	rect(0, -maxEdgeDisplacement-maxEdgeShake+edgeDisplacement+edgeShake-edgeBonus, screenWidth, edgeHeight+maxEdgeDisplacement+maxEdgeShake+edgeBonus);
		        	rect(0, screenHeight-edgeHeight-edgeDisplacement-edgeShake, screenWidth, edgeHeight+maxEdgeDisplacement+maxEdgeShake+edgeBonus);
		        }
		        else{
		        	rect(0, 0, screenWidth, edgeHeight);
		        	rect(0, screenHeight-edgeHeight, screenWidth, edgeHeight);
		        }
		      //   	rotateAmount = map(bassEffect, 0, 255, 0, maxRotate);
				    // var rotateAngle = random(rotateAmount)-maxRotate/2;
				    // translate(screenWidth/2, edgeHeight/2);
				    // rotate(radians(rotateAngle));
				    // rect(0, 0, screenWidth, edgeHeight);
				    // rotate(-radians(rotateAngle));
				    // translate(0, screenHeight-edgeHeight);
				    // rotate(radians(rotateAngle));
				    // rect(0, 0, screenWidth, edgeHeight);
				    // rotate(-radians(rotateAngle));
				    // translate(-screenWidth, -screenHeight+edgeHeight*3/2);
		      //   }
		      //   else{
		      //   	rect(screenWidth/2, edgeHeight/2, screenWidth, edgeHeight);
				    // rect(screenWidth/2, screenHeight-edgeHeight/2, screenWidth, edgeHeight);
		      //   	bassText.style.color = "#000000";
		      //   }

		    }
		    else{
		    	noStroke();
		    	rect(0, 0, screenWidth, edgeHeight);
		        rect(0, screenHeight-edgeHeight, screenWidth, edgeHeight);
		    }
		    fill("rgb(255, 255, 255)");
		    movePlayers(bassEffect);
		    moveBall(edgeDisplacement+edgeShake, bassEffect);
		    rect(playerX+(random(maxPlayerXShake)-maxPlayerXShake/2)*bassEffect, player1Y+(random(maxPlayerYShake)-maxPlayerYShake/2)*bassEffect, playerWidth, playerHeight);
		    rect(screenWidth-playerX-playerWidth+(random(maxPlayerXShake)-maxPlayerXShake/2)*bassEffect, player2Y+(random(maxPlayerYShake)-maxPlayerYShake/2)*bassEffect, playerWidth, playerHeight);
		    ellipse(ballX, ballY, ballDiameter, ballDiameter);
		}

		function movePlayers(bassEffect){
			currentPlayerSpeed = playerSpeed+maxPlayerSpeedBonus*bassEffect;
			if(player1Key == "Up"){
		    	player1Y -= currentPlayerSpeed;
		    }
		    if(player1Key == "Down"){
		    	player1Y += currentPlayerSpeed;
		    }
		    if(player2Key == "Up"){
		    	player2Y -= currentPlayerSpeed;
		    }
		    if(player2Key == "Down"){
		    	player2Y += currentPlayerSpeed;
		    }
		}

		function moveBall(edgeShift, bassEffect){
			if(ballX < 0){
				ballX = 0;
				ballXDirection = 1;
			} else if(ballX > screenWidth-ballDiameter){
				ballX = screenWidth-ballDiameter;
				ballXDirection = -1;
			}
			if(ballY <= 0+edgeShift+edgeHeight){
				ballYDirection = 1;
			} else if(ballY >= screenHeight-ballDiameter-edgeShift-edgeHeight){
				ballYDirection = -1;
			}
			ballX += (defaultBallSpeed+maxBallSpeedBonus*bassEffect)*ballXDirection;
			ballY += (defaultBallSpeed+maxBallSpeedBonus*bassEffect)*ballYDirection;
		}

		function windowResized() {
		  //resizeCanvas(windowWidth, windowHeight);
		}
	</script>
</head> 
<body onload="init()">
	<center>
	<div id="canvasDiv">
	</div>
	<input id="audiofile" type="file"/>
	<h3 class="loader">Loading...</h3>
	<h3 id="bassText"></h3>
	</center>
</body> 
</html>