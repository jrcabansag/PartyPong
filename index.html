<!--Thanks to https://codepen.io/ZachSaucier/pen/bBJmbz for the starter code!-->

<!doctype html> 
<html lang="en"> 
<head> 
	<title>Song Pong</title> 
	<style> 
		body { 
			margin:0;
		}
		input {
		    position: absolute;
		    top: 15px;
		    left: 15px;
		}
		.loader {
		    font-family: sans-serif;
		    position: absolute;
		    top: 50%;
		    left: 50%;
		    transform: translate(-50% -50%);
		    display: none;
		}
		.loader.loading  {
			display: block; 
		}
		#bassText{
			position: absolute;
		    top: 115px;
		    left: 15px;
		}
		#canvasDiv{
			width: 1200px;
			height: 800px;
		}
	</style> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.5/p5.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.5/addons/p5.sound.min.js"></script>
	<script>
		var fft;
		var song;
		var numBars = 1024;
		var loader;
		var bassBars = 10;
		var bassMin = .7;
		var bassMax = 1;
		// Load our song
		function init(){
			loader = document.querySelector(".loader");
			document.getElementById("audiofile").onchange = function(event) {
			    if(event.target.files[0]) {
			        if(typeof song != "undefined") { // Catch already playing songs
			            song.disconnect();
			            song.stop();
			        }
			        
			        // Load our new song
			        song = loadSound(URL.createObjectURL(event.target.files[0]));
			        loader.classList.add("loading");
			    }
			}
		}

		var canvas;
		function setup() { // Setup p5.js
		    canvas = createCanvas(1200, 800);
		    canvas.parent("canvasDiv");
		}

		function draw() {
		    background(51);
		    if(typeof song != "undefined" 
		       && song.isLoaded() 
		       && !song.isPlaying()) { // Do once
		        loader.classList.remove("loading");
		        
		        song.play();
		        song.setVolume(0.5);

		        fft = new p5.FFT();
		        fft.waveform(numBars);
		        fft.smooth(0.85);
		    }
		    
		    if(typeof fft != "undefined") {
		        var spectrum = fft.analyze();
		        noStroke();
		        var totalBass = 0;
		        for(var i = 0; i < numBars; i++) {
		        	if(i <= bassBars){
		        		totalBass += spectrum[i]
						fill("rgb(255, 0, 0)");
		        	}
		        	else{
		        		fill("rgb(0, 255, 0)");
		        	}
		            var x = map(i, 0, numBars, 0, width);
		            var h = -height + map(spectrum[i], 0, 255, height, 0);
		            rect(x, height, width / numBars, h);
		        }
		        var bassPercent = map(totalBass, 0, 255*bassBars, 0, 1);
		        var bassEffect = 0;
		        bassText.innerHTML = ""+bassPercent;
		        if(bassPercent >= bassMin){
		        	bassEffect = map(bassPercent, bassMin, bassMax, 0, 255);
		        	//bassText.style.color = "#FF0000";
		        	bassText.style.color = "#"+bassEffect.toString(16)+"0000";
		        }
		        else{
		        	bassText.style.color = "#000000";
		        }

		    }
		}

		function windowResized() {
		  //resizeCanvas(windowWidth, windowHeight);
		}
	</script>
</head> 
<body onload="init()">
	<center>
	<div id="canvasDiv">
	</div>
	<input id="audiofile" type="file"/>
	<h3 class="loader">Loading...</h3>
	<h3 id="bassText"></h3>
	</center>
</body> 
</html>